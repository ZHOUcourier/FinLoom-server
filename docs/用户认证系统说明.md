# FinLoom ç”¨æˆ·è®¤è¯ç³»ç»Ÿè¯´æ˜

## ğŸ“‹ æ¦‚è¿°

FinLoomå¹³å°å·²ç»é›†æˆäº†å®Œæ•´çš„ç”¨æˆ·è®¤è¯å’Œæ•°æ®éš”ç¦»ç³»ç»Ÿï¼Œæ”¯æŒï¼š
- âœ… ç”¨æˆ·æ³¨å†Œå’Œç™»å½•
- âœ… å®‰å…¨çš„å¯†ç åŠ å¯†å­˜å‚¨ï¼ˆPBKDF2-HMAC-SHA256ï¼‰
- âœ… Token-basedèº«ä»½éªŒè¯
- âœ… ç”¨æˆ·ä¼šè¯ç®¡ç†
- âœ… ç”¨æˆ·æ•°æ®éš”ç¦»
- âœ… ç”¨æˆ·æ´»åŠ¨æ—¥å¿—

## ğŸ—„ï¸ æ•°æ®åº“ç»“æ„

### ç”¨æˆ·è¡¨ (users)
- `user_id`: ç”¨æˆ·IDï¼ˆä¸»é”®ï¼‰
- `username`: ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰
- `email`: é‚®ç®±ï¼ˆå”¯ä¸€ï¼Œå¯é€‰ï¼‰
- `password_hash`: å¯†ç å“ˆå¸Œ
- `salt`: ç›å€¼
- `display_name`: æ˜¾ç¤ºåç§°
- `avatar_url`: å¤´åƒURL
- `created_at`: åˆ›å»ºæ—¶é—´
- `updated_at`: æ›´æ–°æ—¶é—´
- `last_login`: æœ€åç™»å½•æ—¶é—´
- `is_active`: æ˜¯å¦æ¿€æ´»
- `is_admin`: æ˜¯å¦ä¸ºç®¡ç†å‘˜

### ç”¨æˆ·ä¼šè¯è¡¨ (user_sessions)
- `session_id`: ä¼šè¯IDï¼ˆä¸»é”®ï¼‰
- `user_id`: ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰
- `token`: è®¿é—®ä»¤ç‰Œï¼ˆå”¯ä¸€ï¼‰
- `created_at`: åˆ›å»ºæ—¶é—´
- `expires_at`: è¿‡æœŸæ—¶é—´
- `last_activity`: æœ€åæ´»åŠ¨æ—¶é—´
- `ip_address`: IPåœ°å€
- `user_agent`: ç”¨æˆ·ä»£ç†
- `is_valid`: æ˜¯å¦æœ‰æ•ˆ

### ç”¨æˆ·è®¾ç½®è¡¨ (user_settings)
- `setting_id`: è®¾ç½®IDï¼ˆä¸»é”®ï¼‰
- `user_id`: ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰
- `setting_key`: è®¾ç½®é”®
- `setting_value`: è®¾ç½®å€¼
- `updated_at`: æ›´æ–°æ—¶é—´

### ç”¨æˆ·æ´»åŠ¨æ—¥å¿—è¡¨ (user_activity_log)
- `log_id`: æ—¥å¿—IDï¼ˆä¸»é”®ï¼‰
- `user_id`: ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰
- `activity_type`: æ´»åŠ¨ç±»å‹
- `activity_detail`: æ´»åŠ¨è¯¦æƒ…
- `ip_address`: IPåœ°å€
- `timestamp`: æ—¶é—´æˆ³

## ğŸ”Œ åç«¯APIç«¯ç‚¹

### 1. ç”¨æˆ·æ³¨å†Œ
**POST** `/api/auth/register`

è¯·æ±‚ä½“ï¼š
```json
{
  "username": "user123",
  "password": "password123",
  "email": "user@example.com",
  "display_name": "ç”¨æˆ·åç§°"
}
```

å“åº”ï¼š
```json
{
  "status": "success",
  "message": "æ³¨å†ŒæˆåŠŸ",
  "data": {
    "user_id": 1,
    "username": "user123"
  }
}
```

### 2. ç”¨æˆ·ç™»å½•
**POST** `/api/auth/login`

è¯·æ±‚ä½“ï¼š
```json
{
  "username": "user123",
  "password": "password123",
  "remember": true
}
```

å“åº”ï¼š
```json
{
  "status": "success",
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "user_id": 1,
      "username": "user123",
      "email": "user@example.com",
      "display_name": "ç”¨æˆ·åç§°",
      "avatar_url": null,
      "is_admin": false
    }
  }
}
```

### 3. éªŒè¯Token
**GET** `/api/auth/verify`

è¯·æ±‚å¤´ï¼š
```
Authorization: Bearer {token}
```

å“åº”ï¼š
```json
{
  "status": "success",
  "message": "ä»¤ç‰Œæœ‰æ•ˆ",
  "valid": true,
  "user": {
    "user_id": 1,
    "username": "user123",
    ...
  }
}
```

### 4. è·å–ç”¨æˆ·èµ„æ–™
**GET** `/api/auth/profile`

è¯·æ±‚å¤´ï¼š
```
Authorization: Bearer {token}
```

å“åº”ï¼š
```json
{
  "status": "success",
  "data": {
    "user_id": 1,
    "username": "user123",
    "email": "user@example.com",
    "display_name": "ç”¨æˆ·åç§°",
    "avatar_url": null,
    "created_at": "2024-01-01T00:00:00",
    "last_login": "2024-01-01T12:00:00",
    "is_admin": false
  }
}
```

### 5. æ›´æ–°ç”¨æˆ·èµ„æ–™
**PUT** `/api/auth/profile`

è¯·æ±‚å¤´ï¼š
```
Authorization: Bearer {token}
```

è¯·æ±‚ä½“ï¼š
```json
{
  "display_name": "æ–°çš„æ˜¾ç¤ºåç§°",
  "email": "newemail@example.com",
  "avatar_url": "https://example.com/avatar.jpg"
}
```

### 6. ä¿®æ”¹å¯†ç 
**POST** `/api/auth/change-password`

è¯·æ±‚å¤´ï¼š
```
Authorization: Bearer {token}
```

è¯·æ±‚ä½“ï¼š
```json
{
  "old_password": "oldpassword123",
  "new_password": "newpassword123"
}
```

### 7. ç”¨æˆ·ç™»å‡º
**POST** `/api/auth/logout`

è¯·æ±‚å¤´ï¼š
```
Authorization: Bearer {token}
```

## ğŸ–¥ï¸ å‰ç«¯ä½¿ç”¨

### åœ¨å‰ç«¯ä»£ç ä¸­ä½¿ç”¨è®¤è¯API

```javascript
import { api } from '@/services'

// ç”¨æˆ·æ³¨å†Œ
const registerResponse = await api.auth.register({
  username: 'user123',
  password: 'password123',
  email: 'user@example.com'
})

// ç”¨æˆ·ç™»å½•
const loginResponse = await api.auth.login({
  username: 'user123',
  password: 'password123',
  remember: true
})

// ä¿å­˜token
localStorage.setItem('finloom_token', loginResponse.data.data.token)

// éªŒè¯token
const verifyResponse = await api.auth.verify()

// è·å–ç”¨æˆ·èµ„æ–™
const profileResponse = await api.auth.getProfile()

// æ›´æ–°ç”¨æˆ·èµ„æ–™
const updateResponse = await api.auth.updateProfile({
  display_name: 'æ–°åç§°',
  email: 'new@example.com'
})

// ä¿®æ”¹å¯†ç 
const passwordResponse = await api.auth.changePassword({
  old_password: 'old123',
  new_password: 'new123'
})

// ç™»å‡º
const logoutResponse = await api.auth.logout()
```

### åœ¨ç»„ä»¶ä¸­è·å–å½“å‰ç”¨æˆ·

```javascript
import { ref, onMounted } from 'vue'
import { api } from '@/services'

const currentUser = ref(null)

onMounted(async () => {
  try {
    const response = await api.auth.getProfile()
    if (response.data.status === 'success') {
      currentUser.value = response.data.data
    }
  } catch (error) {
    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error)
  }
})
```

## ğŸ”§ åç«¯é›†æˆç”¨æˆ·ä¸Šä¸‹æ–‡

### åœ¨FastAPIè·¯ç”±ä¸­ä½¿ç”¨ç”¨æˆ·è®¤è¯

```python
from fastapi import Depends
from common.user_context import get_current_user, UserContext

@app.get("/api/my-endpoint")
async def my_endpoint(user: UserContext = Depends(get_current_user)):
    """éœ€è¦ç”¨æˆ·è®¤è¯çš„ç«¯ç‚¹"""
    user_id = user.user_id
    username = user.username
    is_admin = user.is_admin
    
    # ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯è¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†
    ...
```

### ä½¿ç”¨è£…é¥°å™¨æ–¹å¼

```python
from common.user_context import require_auth, require_admin

@app.get("/api/protected")
@require_auth
async def protected_endpoint(user: UserContext):
    """éœ€è¦ç”¨æˆ·è®¤è¯"""
    return {"message": f"ä½ å¥½, {user.username}"}

@app.get("/api/admin-only")
@require_admin
async def admin_endpoint(user: UserContext):
    """ä»…ç®¡ç†å‘˜å¯è®¿é—®"""
    return {"message": "ç®¡ç†å‘˜ä¸“ç”¨åŠŸèƒ½"}
```

### ç”¨æˆ·æ•°æ®éš”ç¦»

```python
from common.user_context import UserDataManager

# ä¸ºç”¨æˆ·æ·»åŠ æ•°æ®è¿‡æ»¤
manager = UserDataManager()

# æ–¹å¼1ï¼šåœ¨SQLæŸ¥è¯¢ä¸­æ·»åŠ ç”¨æˆ·è¿‡æ»¤
query_params = {"limit": 10}
query_params = manager.add_user_filter(query_params, user.user_id)
# ç»“æœ: {"limit": 10, "user_id": 1}

# æ–¹å¼2ï¼šéªŒè¯ç”¨æˆ·å¯¹èµ„æºçš„æ‰€æœ‰æƒ
record_user_id = get_record_user_id_from_db(record_id)
manager.require_ownership(record_user_id, user.user_id, user.is_admin)
# å¦‚æœä¸æ˜¯æ‰€æœ‰è€…ä¸”ä¸æ˜¯ç®¡ç†å‘˜ï¼Œä¼šæŠ›å‡º403å¼‚å¸¸

# æ–¹å¼3ï¼šè·å–ç”¨æˆ·ä¸“å±è¡¨å
table_name = manager.get_user_specific_table_name("conversations", user.user_id)
# ç»“æœ: "conversations_user_1"
```

## ğŸ“ ä¿®æ”¹ç°æœ‰æ¨¡å—ä»¥æ”¯æŒç”¨æˆ·éš”ç¦»

### ç¤ºä¾‹ï¼šä¿®æ”¹å¯¹è¯å†å²API

ä¿®æ”¹å‰ï¼ˆæ— ç”¨æˆ·éš”ç¦»ï¼‰ï¼š
```python
@app.get("/api/v1/chat/conversations")
async def get_conversations():
    # è·å–æ‰€æœ‰å¯¹è¯ï¼ˆæ‰€æœ‰ç”¨æˆ·å…±äº«ï¼‰
    conversations = get_all_conversations()
    return conversations
```

ä¿®æ”¹åï¼ˆæœ‰ç”¨æˆ·éš”ç¦»ï¼‰ï¼š
```python
from fastapi import Depends
from common.user_context import get_current_user, UserContext

@app.get("/api/v1/chat/conversations")
async def get_conversations(user: UserContext = Depends(get_current_user)):
    # åªè·å–å½“å‰ç”¨æˆ·çš„å¯¹è¯
    conversations = get_user_conversations(user.user_id)
    return conversations
```

### ç¤ºä¾‹ï¼šä¿®æ”¹æ•°æ®åº“æŸ¥è¯¢

ä¿®æ”¹å‰ï¼š
```python
def get_all_strategies():
    cursor.execute("SELECT * FROM strategies")
    return cursor.fetchall()
```

ä¿®æ”¹åï¼š
```python
def get_user_strategies(user_id: int):
    cursor.execute(
        "SELECT * FROM strategies WHERE user_id = ?",
        (user_id,)
    )
    return cursor.fetchall()
```

## ğŸ§ª æµ‹è¯•

### è¿è¡Œè‡ªåŠ¨æµ‹è¯•
```bash
python test_user_auth.py
```

æµ‹è¯•è„šæœ¬ä¼šè‡ªåŠ¨æµ‹è¯•ï¼š
1. âœ… ç”¨æˆ·æ³¨å†Œ
2. âœ… ç”¨æˆ·ç™»å½•
3. âœ… TokenéªŒè¯
4. âœ… è·å–ç”¨æˆ·èµ„æ–™
5. âœ… æ›´æ–°ç”¨æˆ·èµ„æ–™
6. âœ… æ‹’ç»é”™è¯¯å¯†ç 
7. âœ… æ‹’ç»æ— æ•ˆToken
8. âœ… ç”¨æˆ·ç™»å‡º

### æ‰‹åŠ¨æµ‹è¯•ç™»å½•é¡µé¢
1. å¯åŠ¨æœåŠ¡å™¨ï¼š`python main.py`
2. è®¿é—®ï¼š`http://localhost:8000/login`
3. ç‚¹å‡»"ç«‹å³æ³¨å†Œ"åˆ›å»ºæ–°è´¦æˆ·
4. ä½¿ç”¨æ–°è´¦æˆ·ç™»å½•

## ğŸ” å®‰å…¨ç‰¹æ€§

1. **å¯†ç åŠ å¯†**ï¼šä½¿ç”¨PBKDF2-HMAC-SHA256ç®—æ³•ï¼Œ100,000æ¬¡è¿­ä»£
2. **ç›å€¼**ï¼šæ¯ä¸ªç”¨æˆ·ä½¿ç”¨ç‹¬ç«‹çš„éšæœºç›å€¼
3. **Tokenå®‰å…¨**ï¼š48å­—èŠ‚URLå®‰å…¨éšæœºtoken
4. **ä¼šè¯ç®¡ç†**ï¼šæ”¯æŒè¿‡æœŸæ—¶é—´å’Œè‡ªåŠ¨å¤±æ•ˆ
5. **æ´»åŠ¨æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰ç”¨æˆ·æ´»åŠ¨
6. **SQLæ³¨å…¥é˜²æŠ¤**ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
7. **å¯†ç å¼ºåº¦**ï¼šæœ€å°‘6ä¸ªå­—ç¬¦
8. **ç”¨æˆ·åéªŒè¯**ï¼šæœ€å°‘3ä¸ªå­—ç¬¦

## ğŸ“Š ç”¨æˆ·æ•°æ®éš”ç¦»

æ‰€æœ‰ç”¨æˆ·ç›¸å…³çš„æ•°æ®è¡¨éƒ½åº”è¯¥åŒ…å«`user_id`å­—æ®µï¼Œä»¥ç¡®ä¿æ•°æ®éš”ç¦»ï¼š

```sql
-- ç¤ºä¾‹ï¼šå¯¹è¯å†å²è¡¨
CREATE TABLE conversations (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,  -- ç”¨æˆ·ID
    title TEXT,
    created_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (user_id)
)

-- æŸ¥è¯¢æ—¶å¿…é¡»åŠ ä¸Šç”¨æˆ·è¿‡æ»¤
SELECT * FROM conversations WHERE user_id = ?
```

## ğŸ”„ è¿ç§»ç°æœ‰æ•°æ®

å¦‚æœå·²æœ‰æ•°æ®éœ€è¦æ·»åŠ ç”¨æˆ·éš”ç¦»ï¼š

```sql
-- 1. ä¸ºç°æœ‰è¡¨æ·»åŠ user_idåˆ—
ALTER TABLE existing_table ADD COLUMN user_id INTEGER;

-- 2. ä¸ºç°æœ‰æ•°æ®åˆ†é…é»˜è®¤ç”¨æˆ·ï¼ˆä¾‹å¦‚ç®¡ç†å‘˜ç”¨æˆ·ID=1ï¼‰
UPDATE existing_table SET user_id = 1 WHERE user_id IS NULL;

-- 3. æ·»åŠ å¤–é”®çº¦æŸ
-- SQLiteä¸æ”¯æŒæ·»åŠ å¤–é”®ï¼Œéœ€è¦é‡å»ºè¡¨

-- 4. åˆ›å»ºç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_user_id ON existing_table(user_id);
```

## ğŸ¯ ä¸‹ä¸€æ­¥å·¥ä½œ

1. âœ… åŸºç¡€ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
2. âœ… å‰ç«¯ç™»å½•é¡µé¢é›†æˆ
3. â³ ä¸ºæ‰€æœ‰ç°æœ‰æ¨¡å—æ·»åŠ ç”¨æˆ·éš”ç¦»
4. â³ ç”¨æˆ·æƒé™ç®¡ç†ç³»ç»Ÿ
5. â³ å¤šç§Ÿæˆ·æ”¯æŒ
6. â³ ç¬¬ä¸‰æ–¹ç™»å½•é›†æˆï¼ˆOAuthï¼‰

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- æ—¥å¿—æ–‡ä»¶ï¼š`logs/main.log`
- ç”¨æˆ·æ•°æ®åº“ï¼š`data/users.db`
- æµ‹è¯•è„šæœ¬ï¼š`test_user_auth.py`


